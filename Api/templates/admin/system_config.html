{% extends "base.html" %}

{% block title %}Configuración del Sistema - Launcher Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-gear me-2"></i>Configuración del Sistema
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" @click="resetToDefaults">
                <i class="bi bi-arrow-clockwise"></i> Restaurar Valores por Defecto
            </button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-tools"></i> Herramientas
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" @click="createBackup">
                        <i class="bi bi-cloud-download me-2"></i>Crear Backup
                    </a></li>
                <li><a class="dropdown-item" href="#" @click="testNotifications">
                        <i class="bi bi-bell me-2"></i>Probar Notificaciones
                    </a></li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="{{ url_for('admin.system_status') }}">
                        <i class="bi bi-activity me-2"></i>Estado del Sistema
                    </a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="row">
    <div class="col-lg-3 mb-4">
        <div class="list-group" id="system-config-tabs" role="tablist">
            <a class="list-group-item list-group-item-action active" id="general-tab" data-bs-toggle="list"
                href="#general" role="tab">
                <i class="bi bi-gear me-2"></i>General
            </a>
            <a class="list-group-item list-group-item-action" id="launcher-tab" data-bs-toggle="list" href="#launcher"
                role="tab">
                <i class="bi bi-app me-2"></i>Launcher
            </a>
            <a class="list-group-item list-group-item-action" id="security-tab" data-bs-toggle="list" href="#security"
                role="tab">
                <i class="bi bi-shield-check me-2"></i>Seguridad
            </a>
            <a class="list-group-item list-group-item-action" id="maintenance-tab" data-bs-toggle="list"
                href="#maintenance" role="tab">
                <i class="bi bi-tools me-2"></i>Mantenimiento
            </a>
            <a class="list-group-item list-group-item-action" id="notifications-tab" data-bs-toggle="list"
                href="#notifications" role="tab">
                <i class="bi bi-bell me-2"></i>Notificaciones
            </a>
            <a class="list-group-item list-group-item-action" id="proxy-tab" data-bs-toggle="list" href="#proxy"
                role="tab">
                <i class="bi bi-bell me-2"></i>Proxy
            </a>
        </div>
    </div>

    <div class="col-lg-9">
        <form @submit.prevent="saveConfiguration">
            <div class="tab-content" id="system-config-content">

                <!-- General Tab -->
                <div class="tab-pane fade show active" id="general" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-gear me-2"></i>Configuración General
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="systemName" class="form-label">Nombre del Sistema</label>
                                        <input type="text" class="form-control" id="systemName"
                                            v-model="config.system_name" placeholder="Launcher Admin Panel">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="adminEmail" class="form-label">Email del Administrador</label>
                                        <input type="email" class="form-control" id="adminEmail"
                                            v-model="config.admin_email" placeholder="admin@localhost">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="timezone" class="form-label">Zona Horaria</label>
                                        <select class="form-select" id="timezone" v-model="config.timezone">
                                            <option value="America/Mexico_City">América/Ciudad de México</option>
                                            <option value="America/New_York">América/Nueva York</option>
                                            <option value="Europe/Madrid">Europa/Madrid</option>
                                            <option value="UTC">UTC</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="language" class="form-label">Idioma</label>
                                        <select class="form-select" id="language" v-model="config.language">
                                            <option value="es">Español</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="maintenanceMode"
                                            v-model="config.maintenance_mode">
                                        <label class="form-check-label" for="maintenanceMode">
                                            <strong>Modo de Mantenimiento</strong>
                                            <div class="form-text">Desactiva temporalmente el acceso al launcher</div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="debugMode"
                                            v-model="config.debug_mode">
                                        <label class="form-check-label" for="debugMode">
                                            <strong>Modo de Depuración</strong>
                                            <div class="form-text">Habilita logs detallados para desarrollo</div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div v-if="config.maintenance_mode" class="mb-3">
                                <label for="maintenanceMessage" class="form-label">Mensaje de Mantenimiento</label>
                                <textarea class="form-control" id="maintenanceMessage" rows="3"
                                    v-model="config.maintenance_message"
                                    placeholder="El sistema está temporalmente fuera de servicio..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Proxy Tab -->
                <!-- Proxy Tab -->
                <div class="tab-pane fade" id="proxy" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-globe me-2"></i>Configuración de Proxy
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- ✅ USAR VUE.JS EN LUGAR DE JINJA2 -->
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="proxyEnabled" v-model="config.proxy_enabled">
                                <label class="form-check-label" for="proxyEnabled">
                                    <strong>Habilitar Proxy</strong>
                                    <div class="form-text">Usar servidor proxy para las conexiones del launcher</div>
                                </label>
                            </div>

                            <!-- Mostrar campos solo si el proxy está habilitado -->
                            <div v-show="config.proxy_enabled" class="mt-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="proxyIp" class="form-label">IP del Proxy</label>
                                            <input type="text" class="form-control" id="proxyIp" v-model="config.proxy_ip" placeholder="127.0.0.1" :disabled="!config.proxy_enabled">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="proxyPort" class="form-label">Puerto del Proxy</label>
                                            <input type="number" class="form-control" id="proxyPort" v-model="config.proxy_port" placeholder="8080" min="1" max="65535" :disabled="!config.proxy_enabled">
                                        </div>
                                    </div>
                                </div>

                                <!-- Información adicional del proxy -->
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-info-circle me-2"></i>Información del Proxy</h6>
                                    <small>
                                        <strong>Configuración actual:</strong><br>
                                        IP: [[ config.proxy_ip || 'No configurada' ]]<br>
                                        Puerto: [[ config.proxy_port || 'No configurado' ]]<br>
                                        Estado: <span :class="config.proxy_enabled ? 'text-success' : 'text-muted'">[[
                                            config.proxy_enabled ? 'Habilitado' : 'Deshabilitado' ]]</span>
                                    </small>
                                </div>
                            </div>

                            <!-- Información cuando el proxy está deshabilitado -->
                            <div v-show="!config.proxy_enabled" class="alert alert-secondary">
                                <i class="bi bi-info-circle me-2"></i>
                                El proxy está deshabilitado. Las conexiones se realizarán directamente.
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Launcher Tab -->
                <div class="tab-pane fade" id="launcher" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-app me-2"></i>Configuración del Launcher
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="launcherBaseUrl" class="form-label">URL Base del Launcher</label>
                                        <input type="url" class="form-control" id="launcherBaseUrl"
                                            v-model="config.launcher_base_url"
                                            placeholder="http://localhost:5000/Launcher">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="updateCheckInterval" class="form-label">Intervalo de Verificación
                                            (segundos)</label>
                                        <input type="number" class="form-control" id="updateCheckInterval"
                                            v-model="config.update_check_interval" min="60" max="3600">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="maxDownloadRetries" class="form-label">Máximo Reintentos de
                                            Descarga</label>
                                        <input type="number" class="form-control" id="maxDownloadRetries"
                                            v-model="config.max_download_retries" min="1" max="10">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="connectionTimeout" class="form-label">Timeout de Conexión
                                            (segundos)</label>
                                        <input type="number" class="form-control" id="connectionTimeout"
                                            v-model="config.connection_timeout" min="10" max="120">
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="autoUpdateEnabled"
                                            v-model="config.auto_update_enabled">
                                        <label class="form-check-label" for="autoUpdateEnabled">
                                            <strong>Actualización Automática</strong>
                                            <div class="form-text">Permitir que el launcher se actualice automáticamente
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="forceSsl"
                                            v-model="config.force_ssl">
                                        <label class="form-check-label" for="forceSsl">
                                            <strong>Forzar SSL/HTTPS</strong>
                                            <div class="form-text">Requerir conexiones seguras para todas las descargas
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div class="tab-pane fade" id="security" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-shield-check me-2"></i>Configuración de Seguridad
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="sessionDuration" class="form-label">Duración de Sesión
                                            (horas)</label>
                                        <input type="number" class="form-control" id="sessionDuration"
                                            v-model="config.session_duration_hours" min="1" max="168">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="maxLoginAttempts" class="form-label">Máximo Intentos de
                                            Login</label>
                                        <input type="number" class="form-control" id="maxLoginAttempts"
                                            v-model="config.max_login_attempts" min="3" max="10">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="downloadRateLimit" class="form-label">Límite de Descargas por
                                            Hora</label>
                                        <input type="number" class="form-control" id="downloadRateLimit"
                                            v-model="config.download_rate_limit" min="10" max="1000">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="ipBanDuration" class="form-label">Duración de Ban por IP (minutos)</label>
                                <input type="number" class="form-control" id="ipBanDuration"
                                    v-model="config.ip_ban_duration_minutes" min="1" max="1440"
                                    style="max-width: 200px;">
                            </div>

                            <div class="mb-3">
                                <label for="ipWhitelist" class="form-label">IPs Permitidas (Whitelist)</label>
                                <textarea class="form-control" id="ipWhitelist" rows="5" v-model="ipWhitelistText"
                                    placeholder="192.168.1.1&#10;10.0.0.0/8&#10;Dejar vacío para permitir todas"></textarea>
                                <div class="form-text">Una IP por línea. Soporta CIDR</div>
                            </div>

                            <hr class="my-4">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="rateLimitingEnabled"
                                            v-model="config.rate_limiting_enabled">
                                        <label class="form-check-label" for="rateLimitingEnabled">
                                            <strong>Habilitar Límite de Velocidad</strong>
                                            <div class="form-text">Limitar número de descargas por IP</div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="logAllRequests"
                                            v-model="config.log_all_requests">
                                        <label class="form-check-label" for="logAllRequests">
                                            <strong>Registrar Todas las Solicitudes</strong>
                                            <div class="form-text">Guardar log de todas las descargas</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Maintenance Tab -->
                <div class="tab-pane fade" id="maintenance" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-tools me-2"></i>Mantenimiento del Sistema
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <i class="bi bi-exclamation-triangle text-warning"
                                                style="font-size: 2rem;"></i>
                                            <h6 class="mt-2">Control de Mantenimiento</h6>
                                            <div class="form-check form-switch d-flex justify-content-center mt-3">
                                                <input class="form-check-input" type="checkbox"
                                                    id="quickMaintenanceToggle" v-model="config.maintenance_mode"
                                                    @change="quickMaintenanceToggle">
                                                <label class="form-check-label ms-2" for="quickMaintenanceToggle">
                                                    <strong v-if="config.maintenance_mode" class="text-warning">Modo
                                                        Activo</strong>
                                                    <strong v-else class="text-success">Modo Inactivo</strong>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <i class="bi bi-cloud-download text-info" style="font-size: 2rem;"></i>
                                            <h6 class="mt-2">Crear Backup</h6>
                                            <button type="button" class="btn btn-info btn-sm mt-2" @click="createBackup"
                                                :disabled="creatingBackup">
                                                <span v-if="creatingBackup">
                                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                                    Creando...
                                                </span>
                                                <span v-else>
                                                    <i class="bi bi-download me-2"></i>
                                                    Crear Backup
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <h6><i class="bi bi-info-circle me-2"></i>Información del Sistema</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small>
                                            <strong>Última Configuración:</strong><br>
                                            [[ formatDate(config.updated_at) ]]
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small>
                                            <strong>Estado Actual:</strong><br>
                                            <span v-if="config.maintenance_mode" class="text-warning">En
                                                Mantenimiento</span>
                                            <span v-else class="text-success">Operativo</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div class="tab-pane fade" id="notifications" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-bell me-2"></i>Configuración de Notificaciones
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="webhookUrl" class="form-label">URL de Webhook</label>
                                        <input type="url" class="form-control" id="webhookUrl"
                                            v-model="config.webhook_url"
                                            placeholder="Para notificaciones vía Slack, Discord, etc.">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="notificationEmail" class="form-label">Email para Alertas</label>
                                        <input type="email" class="form-control" id="notificationEmail"
                                            v-model="config.notification_email" placeholder="admin@example.com">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="alertLevel" class="form-label">Nivel de Alerta</label>
                                <select class="form-select" id="alertLevel" v-model="config.alert_level"
                                    style="max-width: 300px;">
                                    <option value="all">Todas las Notificaciones</option>
                                    <option value="warnings">Advertencias y Errores</option>
                                    <option value="errors_only">Solo Errores</option>
                                </select>
                            </div>

                            <hr class="my-4">

                            <h6>Tipos de Notificación</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="notifyNewVersions"
                                            v-model="config.notify_new_versions">
                                        <label class="form-check-label" for="notifyNewVersions">
                                            <strong>Nuevas Versiones</strong>
                                            <div class="form-text">Notificar cuando se sube una nueva versión</div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="notifySystemErrors"
                                            v-model="config.notify_system_errors">
                                        <label class="form-check-label" for="notifySystemErrors">
                                            <strong>Errores del Sistema</strong>
                                            <div class="form-text">Notificar errores críticos y fallos</div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="notifyHighTraffic"
                                            v-model="config.notify_high_traffic">
                                        <label class="form-check-label" for="notifyHighTraffic">
                                            <strong>Tráfico Alto</strong>
                                            <div class="form-text">Notificar cuando hay muchas descargas</div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-info btn-sm" @click="testNotifications">
                                    <i class="bi bi-bell me-2"></i>Enviar Notificación de Prueba
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button type="button" class="btn btn-outline-secondary me-md-2" @click="resetForm">
                    <i class="bi bi-arrow-clockwise"></i> Restaurar
                </button>
                <button type="submit" class="btn btn-primary" :disabled="saving">
                    <span v-if="saving">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Guardando...
                    </span>
                    <span v-else>
                        <i class="bi bi-check-circle"></i> Guardar Configuración
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block vue_script %}
<script>
    // Prevenir instancia Vue por defecto
    window.DISABLE_DEFAULT_VUE = true;

    // Datos del servidor
    window.SYSTEM_CONFIG = {{ config.to_dict() | tojson }};
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Iniciando System Config Vue.js');

        // Verificaciones de dependencias
        if (typeof Vue === 'undefined') {
            console.error('❌ Vue.js no está disponible');
            return;
        }

        Vue.config.delimiters = ['[[', ']]'];

        const systemConfigApp = new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            mixins: [NotificationMixin, HttpMixin, UtilsMixin, SocketMixin],

            data() {
                return {
                    config: window.SYSTEM_CONFIG || {},
                    originalConfig: {},
                    saving: false,
                    creatingBackup: false,
                    loading: false,
                    loadingMessage: 'Cargando...',
                    isSocketConnected: false,
                    socket: null
                };
            },

            computed: {
                ipWhitelistText: {
                    get() {
                        return Array.isArray(this.config.ip_whitelist)
                            ? this.config.ip_whitelist.join('\n')
                            : '';
                    },
                    set(value) {
                        this.config.ip_whitelist = value
                            .split('\n')
                            .map(ip => ip.trim())
                            .filter(ip => ip.length > 0);
                    }
                }
            },

            mounted() {
                console.log('✅ System Config Vue montado');
                this.initSocket();
                this.originalConfig = JSON.parse(JSON.stringify(this.config));
                console.log('Config cargada:', this.config);
            },

            methods: {
                async saveConfiguration() {
                    this.saving = true;

                    try {
                        // Confirmar si hay cambios importantes
                        if (this.config.maintenance_mode && !this.originalConfig.maintenance_mode) {
                            const confirmed = await this.showConfirmation(
                                '¿Activar Modo Mantenimiento?',
                                'Esto deshabilitará temporalmente el acceso al launcher. ¿Continuar?',
                                'Sí, activar'
                            );
                            if (!confirmed) {
                                this.saving = false;
                                return;
                            }
                        }

                        const response = await this.apiPost('/admin/system/config/update', this.config);

                        this.showSuccess('Configuración guardada', 'La configuración del sistema ha sido actualizada exitosamente');
                        this.originalConfig = JSON.parse(JSON.stringify(this.config));

                        // Emitir evento SocketIO
                        if (this.isSocketConnected) {
                            this.emitSocket('config_updated', {
                                maintenance_mode: this.config.maintenance_mode,
                                debug_mode: this.config.debug_mode
                            });
                        }

                    } catch (error) {
                        console.error('Error guardando configuración:', error);
                        // El manejo de errores ya está en HttpMixin
                    } finally {
                        this.saving = false;
                    }
                },

                async quickMaintenanceToggle() {
                    try {
                        const response = await this.apiPost('/admin/system/maintenance/toggle', {
                            enabled: this.config.maintenance_mode,
                            message: this.config.maintenance_message || 'Sistema en mantenimiento'
                        });

                        const status = this.config.maintenance_mode ? 'activado' : 'desactivado';
                        this.showSuccess(`Modo mantenimiento ${status}`, `El modo mantenimiento ha sido ${status} exitosamente`);

                    } catch (error) {
                        // Revertir el toggle si falló
                        this.config.maintenance_mode = !this.config.maintenance_mode;
                        console.error('Error toggling maintenance mode:', error);
                    }
                },

                async createBackup() {
                    this.creatingBackup = true;

                    try {
                        const response = await this.apiPost('/admin/system/backup/create');

                        this.showSuccess('Backup creado', `Backup creado exitosamente: ${response.backup_file}`);

                    } catch (error) {
                        console.error('Error creando backup:', error);
                    } finally {
                        this.creatingBackup = false;
                    }
                },

                async testNotifications() {
                    try {
                        const response = await this.apiPost('/admin/system/test_notification', {
                            type: 'test'
                        });

                        this.showSuccess('Notificación enviada', 'Notificación de prueba enviada exitosamente');

                    } catch (error) {
                        console.error('Error enviando notificación de prueba:', error);
                    }
                },

                resetForm() {
                    this.config = JSON.parse(JSON.stringify(this.originalConfig));
                    this.showInfo('Formulario restaurado', 'Los cambios no guardados han sido descartados');
                },

                async resetToDefaults() {
                    const confirmed = await this.showConfirmation(
                        '¿Restaurar valores por defecto?',
                        'Esto restablecerá toda la configuración a los valores por defecto. ¿Continuar?',
                        'Sí, restaurar'
                    );

                    if (confirmed) {
                        // Valores por defecto
                        this.config = {
                            system_name: 'Launcher Admin Panel',
                            admin_email: 'admin@localhost',
                            timezone: 'America/Mexico_City',
                            language: 'es',
                            maintenance_mode: false,
                            maintenance_message: 'Sistema en mantenimiento',
                            debug_mode: false,
                            launcher_base_url: 'http://localhost:5000/Launcher',
                            update_check_interval: 300,
                            max_download_retries: 3,
                            connection_timeout: 30,
                            auto_update_enabled: true,
                            force_ssl: false,
                            proxy_enabled: false,
                            proxy_ip: '127.0.0.1',
                            proxy_port: 8080,
                            session_duration_hours: 24,
                            max_login_attempts: 5,
                            download_rate_limit: 100,
                            ip_ban_duration_minutes: 60,
                            rate_limiting_enabled: true,
                            log_all_requests: true,
                            ip_whitelist: [],
                            webhook_url: '',
                            notification_email: '',
                            alert_level: 'errors_only',
                            notify_new_versions: true,
                            notify_system_errors: true,
                            notify_high_traffic: false
                        };

                        this.showInfo('Valores restaurados', 'La configuración ha sido restaurada a los valores por defecto');
                    }
                },

                setLoading(isLoading, message = 'Cargando...') {
                    this.loading = isLoading;
                    this.loadingMessage = message;
                },

                testSocketConnection() {
                    if (this.isSocketConnected) {
                        this.emitSocket('ping');
                        this.showInfo('Test SocketIO', 'Ping enviado al servidor');
                    } else {
                        this.showWarning('Sin conexión', 'SocketIO no está conectado');
                    }
                }
            }
        });

        // Exponer para debugging
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.systemConfigApp = systemConfigApp;
            console.log('✅ System Config app disponible en window.systemConfigApp');
        }

        console.log('✅ System Config Vue.js inicializado exitosamente');
    });
</script>
{% endblock %}